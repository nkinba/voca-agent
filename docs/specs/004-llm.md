# Micro-PRD: LLM Vocabulary Extraction

## 1. Goal
- `voca-core`에 정의된(혹은 추가될) 인터페이스를 통해 텍스트를 입력받아, TOEFL 수준의 어휘와 예문을 추출한다.
- Rust 기반의 LLM 프레임워크인 **Rig**를 사용하여 구조화된 데이터(JSON)를 안정적으로 받아낸다.
- 패키지명: `voca-llm`

## 2. Dependencies (`crates/llm/Cargo.toml`)
- `voca-core`: { path = "../core" }
- `rig-core`: "0.2" (또는 최신 버전)
- `serde`: { version = "1.0", features = ["derive"] }
- `serde_json`: "1.0"
- `tokio`: { workspace = true }
- `dotenvy`: "0.15" (API Key 로드용)

## 3. Specifications

### 3.1. Interface Update (`voca-core`)
*가장 먼저 Core에 이 Trait이 없다면 추가해야 함.*

```rust
// crates/core/src/port.rs
#[async_trait]
pub trait LlmPort: Send + Sync {
    /// 텍스트 원문을 받아 학습할 단어 리스트를 반환
    async fn extract(&self, text: &str) -> Result<Vec<Vocabulary>, CoreError>;
}
```

### 3.2. Struct & Logic (`voca-llm`)
- **Struct:** `RigLlmEngine`
- **Fields:** `agent: rig::agent::Agent` (OpenAI 또는 Anthropic 모델 설정)
- **Prompt Engineering (System Prompt):**
    > "You are a strict TOEFL exam creator. Identify 3-5 distinct English words from the text that are CEFR Level C1 or C2.
    > Ignore common words. For each word, provide:
    > 1. The word itself (lemma form).
    > 2. A concise definition in English suitable for academic context.
    > 3. The specific sentence from the text where it was used (context).
    > Output must be valid JSON."

### 3.3. Implementation Details (Using Rig)
- **Extraction Pattern:** Rig의 `extract<T>` 기능을 사용하여 `Vec<Vocabulary>` 형태로 바로 매핑되도록 구현. (JSON 파싱 에러 자동 재시도 기능 활용)
- **Filtering Logic:**
    - 1차: 프롬프트에서 "C1/C2 Level only" 제약.
    - 2차(Optional): 추출된 단어의 길이가 3 이하이거나, 기본 불용어(Stop words)에 포함되면 Rust 코드 레벨에서 `filter`로 제거.

## 4. Testing Requirements
- **Integration Test:** 실제 OpenAI API 키(`OPENAI_API_KEY`)를 사용하여 실제 응답이 JSON으로 잘 오는지 확인.
- **Cost Control:** 테스트 코드 실행 시 토큰 소모를 줄이기 위해 짧은 텍스트 샘플 사용.

## 5. Agent Instruction
1. `crates/llm`을 생성하고 의존성을 세팅한다.
2. `voca-core`에 `LlmPort`가 없다면 먼저 정의한다.
3. `Rig` 라이브러리를 사용하여 `RigLlmEngine` 구조체를 구현한다.
4. 프롬프트는 상수로 관리하여 수정이 용이하게 한다.