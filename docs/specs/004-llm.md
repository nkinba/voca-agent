# Micro-PRD: LLM Vocabulary Extraction

## 1. Goal
- `voca-core`에 정의된 인터페이스를 통해 텍스트를 입력받아, TOEFL 수준의 어휘와 예문을 추출한다.
- **Gemini 1.5 Flash** 모델을 사용하여 빠르고 비용 효율적으로 데이터를 처리한다.
- 패키지명: `voca-llm`

## 2. Dependencies (`crates/llm/Cargo.toml`)
- `voca-core`: { path = "../core" }
- `reqwest`: { version = "0.11", features = ["json", "rustls-tls"] }
- `serde`: { version = "1.0", features = ["derive"] }
- `serde_json`: "1.0"
- `tokio`: { workspace = true }
- `dotenvy`: "0.15" (API Key 로드용)
- `thiserror`: "1.0"

## 3. Specifications

### 3.1. Struct & Logic (`voca-llm`)
- **Struct:** `GeminiLlmEngine`
- **Fields:**
  - `api_key`: `String` (Environment Variable `GEMINI_API_KEY`)
  - `model`: `String` (Default: "gemini-1.5-flash")
  - `client`: `reqwest::Client`

### 3.2. API Integration (Google AI Studio)
- **Endpoint:** `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={API_KEY}`
- **Request Body:**
  ```json
  {
    "contents": [{
      "parts": [{"text": "{SYSTEM_PROMPT}\n\nTarget Text:\n{INPUT_TEXT}"}]
    }],
    "generationConfig": {
        "response_mime_type": "application/json"
    }
  }
    ```

Note: Gemini 1.5는 response_mime_type을 application/json으로 설정하면 JSON 모드가 강제되어 파싱 에러를 방지할 수 있음.

###  3.3. Prompt Engineering
- System Prompt:
"You are a strict TOEFL exam creator. Identify 3-5 distinct English words from the text that are CEFR Level C1 or C2. Ignore common words. Output a JSON list of objects with the following keys:
    - 'word': The lemma of the word.
    - 'definition': A concise academic definition.
    - 'context_sentence': The sentence from the text containing the word."

## 4. Testing Requirements
- Integration Test: `GEMINI_API_KEY` 환경변수가 있을 때만 실행되도록 #[ignore] 태그 처리.
- Mocking: 단위 테스트(Unit Test)를 위해 `reqwest` 호출을 모킹(Mockito 등 활용)하거나, `LlmPort` 트레이트를 구현한 가짜 구조체 `MockLlmEngine`을 별도로 제공하여 app 테스트 시 활용.

## 5. Agent Instruction
- `crates/llm` 디렉토리를 생성하고 `Cargo.toml` 의존성을 세팅한다.
- `voca-core`의 `LlmPort` 트레이트를 구현하는 `GeminiLlmEngine` 구조체를 작성한다.
- Google AI Studio API 규격에 맞춰 `reqwest`로 통신 로직을 구현한다. (JSON 파싱 포함)
- 응답이 200 OK가 아니거나 파싱에 실패할 경우에 대한 `CoreError` 변환 로직을 포함한다.